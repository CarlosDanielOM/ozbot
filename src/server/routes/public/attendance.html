<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Attendance</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="">
    <div class="bg-white min-h-screen">
        <header class="p-4 flex justify-between items-center bg-[#8B4513]">
            <div class="flex items-center space-x-4">
                <button class="outline icon-btn" onclick="window.history.back()">
                    <span class="left-arrow h-4 w-4"><-</span>
                </button>
            </div>
            <div class="text-white">
                <div class="local-time" id="local-time">Local Time: 12:00 AM</div>
                <div class="server-time" id="server-time">Server Time: 12:00 AM</div>
            </div>
            <div class="flex items-center space-x-4">
                <select name="sort-by" id="sort-by" class="w-[180px] p-2 text-center text-white bg-orange-200 rounded-md">
                    <option value="sort">Sort By</option>
                    <option value="name">Name</option>
                    <option value="total">Total</option>
                </select>
                <select name="sort-order" id="sort-order" class="w-[180px] p-2 text-center text-white bg-orange-200 rounded-md">
                    <option value="asc">Ascending</option>
                    <option value="desc">Descending</option>
                </select>
                <div id="date-picker" class="">
                    <input type="date" id="attendance-date" class="p-2 text-center bg-orange-200 text-white rounded-md" min="2024-12-31" value="2024-12-31">
                </div>
            </div>
        </header>
        <main class="container mx-auto mt-8">
            <h1 class="text-4xl font-bold mb-8 text-center text-[#8B4513]">Attendance</h1>
            <div id="card-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
                <div class="card border border-gray-200 bg-white shadow-md overflow-hidden">
                    <div class="card-body p-4">
                        <h2 class="text-xl font-semibold mb-2">OzBellVT</h2>
                        <p class="mb-2">Overall Attendance: 88%</p>
                        <div class="bar h-2 mb-4 bg-green-500 w-[88%]"></div>
                        <h3 class="font-semibold mb-2">Attendance for 01-18-2025 :</h3>
                        <div class="attendance-score flex">
                            <div class="w-6 h-6 mr-1 rounded-full flex items-center justify-center text-xs text-white bg-green-500" title="present" key="1">1</div>
                            <div class="w-6 h-6 mr-1 rounded-full flex items-center justify-center text-xs text-white bg-green-500" title="present" key="2">2</div>
                            <div class="w-6 h-6 mr-1 rounded-full flex items-center justify-center text-xs text-white bg-red-500" title="absent" key="3">3</div>
                            <div class="w-6 h-6 mr-1 rounded-full flex items-center justify-center text-xs text-white bg-green-500" title="present" key="4">4</div>
                            <div class="w-6 h-6 mr-1 rounded-full flex items-center justify-center text-xs text-white bg-red-500" title="absent" key="5">5</div>
                            <div class="w-6 h-6 mr-1 rounded-full flex items-center justify-center text-xs text-white bg-green-500" title="present" key="6">6</div>
                            <div class="w-6 h-6 mr-1 rounded-full flex items-center justify-center text-xs text-white bg-green-500" title="present" key="7">7</div>
                            <div class="w-6 h-6 mr-1 rounded-full flex items-center justify-center text-xs text-white bg-green-500" title="present" key="8">8</div>
                        </div>
                    </div>
                </div>
                <div class="card border border-gray-200 bg-white shadow-md overflow-hidden">
                    <div class="card-body p-4">
                        <h2 class="text-xl font-semibold mb-2">CDOM201</h2>
                        <p class="mb-2">Overall Attendance: 33%</p>
                        <div class="bar h-2 mb-4 bg-orange-500 w-[33%]"></div>
                        <h3 class="font-semibold mb-2">Attendance for 01-18-2025 :</h3>
                        <div class="attendance-score flex">
                            <div class="w-6 h-6 mr-1 rounded-full flex items-center justify-center text-xs text-white bg-green-500" title="present" key="1">1</div>
                            <div class="w-6 h-6 mr-1 rounded-full flex items-center justify-center text-xs text-white bg-green-500" title="present" key="2">2</div>
                            <div class="w-6 h-6 mr-1 rounded-full flex items-center justify-center text-xs text-white bg-red-500" title="absent" key="3">3</div>
                            <div class="w-6 h-6 mr-1 rounded-full flex items-center justify-center text-xs text-white bg-green-500" title="present" key="4">4</div>
                            <div class="w-6 h-6 mr-1 rounded-full flex items-center justify-center text-xs text-white bg-red-500" title="absent" key="5">5</div>
                            <div class="w-6 h-6 mr-1 rounded-full flex items-center justify-center text-xs text-white bg-green-500" title="present" key="6">6</div>
                            <div class="w-6 h-6 mr-1 rounded-full flex items-center justify-center text-xs text-white bg-green-500" title="present" key="7">7</div>
                            <div class="w-6 h-6 mr-1 rounded-full flex items-center justify-center text-xs text-white bg-green-500" title="present" key="8">8</div>
                        </div>
                    </div>
                </div>
                <div class="card border border-gray-200 bg-white shadow-md overflow-hidden">
                    <div class="card-body p-4">
                        <h2 class="text-xl font-semibold mb-2">IrithDream</h2>
                        <p class="mb-2">Overall Attendance: 60%</p>
                        <div class="bar h-2 mb-4 bg-yellow-500 w-[60%]"></div>
                        <h3 class="font-semibold mb-2">Attendance for 01-18-2025 :</h3>
                        <div class="attendance-score flex">
                            <p>No attendance data for this date.</p>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
    <script type="module">
        const cardContainer = document.getElementById('card-container');
        const sortSelect = document.getElementById('sort-by');
        const orderSelect = document.getElementById('sort-order');
        const attendanceDate = document.getElementById('attendance-date');
        const localTime = document.getElementById('local-time');
        const serverTime = document.getElementById('server-time');

        let sortingType = 'name';
        let sortingOrder = 'asc';

        sortSelect.addEventListener('change', () => {
            sortingType = sortSelect.value;
            displayCards();
        });

        orderSelect.addEventListener('change', () => {
            sortingOrder = orderSelect.value;
            displayCards();
        });

        attendanceDate.addEventListener('change', async () => {
            const selectedDate = new Date(attendanceDate.value);
            const year = selectedDate.getFullYear();
            const month = selectedDate.getMonth() + 1;
            const day = selectedDate.getDate();

            selectedDateSaved = `${year}-${month}-${day}`;

            let attendance = await getAttendance(day, month, year);
            displayCards();
        });

        function displayCards(userData) {
            for (let i = 0; i < userData.length; i++) {
                const card = document.createElement('div');
                card.classList.add('card', 'border', 'border-gray-200', 'bg-white', 'shadow-md', 'overflow-hidden');
                const cardBody = document.createElement('div');
                cardBody.classList.add('card-body', 'p-4');
                const cardTitle = document.createElement('h2');
                cardTitle.classList.add('text-xl', 'font-semibold', 'mb-2');
                cardTitle.textContent = userData[i].login;
                const cardText = document.createElement('p');
                cardText.classList.add('mb-2');
                cardText.textContent = `Overall Attendance: ${userData[i].present}/${userData[i].total}`;
                const bar = document.createElement('div');
                bar.classList.add('bar', 'h-2', 'mb-4');
                bar.style.backgroundColor = userData[i].present / userData[i].total > 0.5 ? '#008000' : '#FF0000';
                bar.style.width = `${userData[i].present / userData[i].total * 100}%`;
                const attendanceDate = document.createElement('h3');
                attendanceDate.classList.add('font-semibold', 'mb-2');
                attendanceDate.textContent = `Attendance for ${selectedDateSaved} :`;
                const attendanceScore = document.createElement('div');
                attendanceScore.classList.add('attendance-score', 'flex');
                for (let j = 0; j < userData[i].present; j++) {
                    const attendanceScoreItem = document.createElement('div');
                    attendanceScoreItem.classList.add('w-6', 'h-6', 'mr-1', 'rounded-full', 'flex', 'items-center', 'justify-center', 'text-xs', 'text-white', 'bg-green-500');
                    attendanceScoreItem.setAttribute('title', 'present');
                    attendanceScoreItem.textContent = j + 1;
                    attendanceScore.appendChild(attendanceScoreItem);
                    cardBody.appendChild(attendanceScore);
                }
                cardBody.appendChild(cardTitle);
                cardBody.appendChild(cardText);
                cardBody.appendChild(bar);
                cardBody.appendChild(attendanceDate);
                cardBody.appendChild(attendanceScore);
                card.appendChild(cardBody);
                cardContainer.appendChild(card);
            }
        }

        /*
            <div class="card border border-gray-200 bg-white shadow-md overflow-hidden">
                    <div class="card-body p-4">
                        <h2 class="text-xl font-semibold mb-2">OzBellVT</h2>
                        <p class="mb-2">Overall Attendance: 88%</p>
                        <div class="bar h-2 mb-4 bg-green-500 w-[88%]"></div>
                        <h3 class="font-semibold mb-2">Attendance for 01-18-2025 :</h3>
                        <div class="attendance-score flex">
                            <div class="w-6 h-6 mr-1 rounded-full flex items-center justify-center text-xs text-white bg-green-500" title="present" key="1">1</div>
                            <div class="w-6 h-6 mr-1 rounded-full flex items-center justify-center text-xs text-white bg-green-500" title="present" key="2">2</div>
                            <div class="w-6 h-6 mr-1 rounded-full flex items-center justify-center text-xs text-white bg-red-500" title="absent" key="3">3</div>
                            <div class="w-6 h-6 mr-1 rounded-full flex items-center justify-center text-xs text-white bg-green-500" title="present" key="4">4</div>
                            <div class="w-6 h-6 mr-1 rounded-full flex items-center justify-center text-xs text-white bg-red-500" title="absent" key="5">5</div>
                            <div class="w-6 h-6 mr-1 rounded-full flex items-center justify-center text-xs text-white bg-green-500" title="present" key="6">6</div>
                            <div class="w-6 h-6 mr-1 rounded-full flex items-center justify-center text-xs text-white bg-green-500" title="present" key="7">7</div>
                            <div class="w-6 h-6 mr-1 rounded-full flex items-center justify-center text-xs text-white bg-green-500" title="present" key="8">8</div>
                        </div>
                    </div>
                </div>
        */
    </script>
    <!-- <script type="module">

        let display = document.getElementById('display');
        let sortingTypeElement = document.getElementById('sortingType');
        let sortingOrderElement = document.getElementById('sortingOrder');
        let attendanceDateElement;
        let selectedDateSaved = null;
        
        let sortingType = 'login'; // login, present, total
        let sortingOrder = 'asc';

        sortingTypeElement.addEventListener('change', (e) => {
            sortingType = e.target.value;
            displayAttendance(sortAttendance(attendance.data));
        });

        sortingOrderElement.addEventListener('change', (e) => {
            sortingOrder = e.target.value;
            displayAttendance(sortAttendance(attendance.data));
        });

        function sortAttendance(attendance) {
            let sortedAttendance = attendance.slice();
            sortedAttendance.sort((a, b) => {
                if(a[sortingType] < b[sortingType]) {
                    return -1;
                } else if(a[sortingType] > b[sortingType]) {
                    return 1;
                } else {
                    return 0;
                }
            });
            if(sortingOrder === 'desc') {
                sortedAttendance.reverse();
            }
            return sortedAttendance;
        }
        
        async function getAttendance(day = null, month = null, year = null) {
            let params = new URLSearchParams();
            if(day) {
                params.append('day', day);
            }
            if(month) {
                params.append('month', month);
            }
            if(year) {
                params.append('year', year);
            }
            let response = await fetch('https://oz.domdimabot.com/attendance' + '?' + params.toString());
            let data = await response.json();
            if(data.status === 200) {

                //Eliminate duplicates and also the user total
                data.data = data.data.filter((user, index) => {
                    if(user.login === 'total') return false;
                    return data.data.findIndex(u => u.login === user.login) === index;
                });

                attendanceDateElement = document.createElement('input');
                attendanceDateElement.type = 'date';
                attendanceDateElement.id = 'attendanceDate';
                attendanceDateElement.classList.add('p-2', 'text-center', 'bg-orange-200', 'text-white', 'rounded-md');
                attendanceDateElement.min = '2024-12-31';
                attendanceDateElement.max = new Date().toISOString().split('T')[0];
                attendanceDateElement.value = selectedDateSaved ?? `${new Date().toISOString().split('T')[0]}`;
                document.getElementById('datePicker').innerHTML = '';
                document.getElementById('datePicker').appendChild(attendanceDateElement);

                attendanceDateElement.addEventListener('change', async (e) => {
                const selecetedDate = new Date(e.target.value);
                const year = selecetedDate.getFullYear();
                const month = selecetedDate.getMonth() + 1;
                const day = selecetedDate.getDate();

                selectedDateSaved = `${year}-${month}-${day}`;

                let attendance = await getAttendance(day, month, year);
                displayAttendance(sortAttendance(attendance.data));
            });
                
                return {data: data.data, server_time: data.server_time, server_date: data.server_date};
            } else {
                console.log({data});
            }
        }

        let attendance = await getAttendance();

        function dualTimes(server_time, local_time = null) {
            console.log({server_time})
            if(!local_time) {
                local_time = new Date();
            }

            let localTimeString = "AM";
            if(local_time.getHours() > 12) {
                localTimeString = "PM";
                local_time.setHours(local_time.getHours() - 12);
            }

            let serverTimeString = "AM";
            if(server_time.hours > 12) {
                serverTimeString = "PM";
                server_time.hours = server_time.hours - 12;
            }
            
            let serverHours = server_time.hours;
            let serverMinutes = server_time.minutes;
            let serverSeconds = server_time.seconds;

            let localHours = local_time.getHours();
            let localMinutes = local_time.getMinutes();
            let localSeconds = local_time.getSeconds();

            let serverTimeElement = document.getElementById('serverTime');
            let localTimeElement = document.getElementById('localTime');

            serverTimeElement.innerHTML = `${serverHours}:${serverMinutes}:${serverSeconds} ${serverTimeString}`;
            localTimeElement.innerHTML = `${localHours}:${localMinutes}:${localSeconds} ${localTimeString}`;

            setInterval(() => {
                serverTimeElement.innerHTML = `${serverHours}:${serverMinutes}:${serverSeconds} ${serverTimeString}`;
                localTimeElement.innerHTML = `${localHours}:${localMinutes}:${localSeconds} ${localTimeString}`;
                
                serverSeconds++;
                if(serverHours > 23) {
                    serverHours = 0;
                    serverMinutes++;
                    if(serverMinutes > 59) {
                        serverMinutes = 0;
                        serverSeconds++;
                        if(serverSeconds > 59) {
                            serverSeconds = 0;
                        }
                    }
                }
                localSeconds++;
                if(localHours > 23) {
                    localHours = 0;
                    localMinutes++;
                    if(localMinutes > 59) {
                        localMinutes = 0;
                        localSeconds++;
                        if(localSeconds > 59) {
                            localSeconds = 0;
                        }
                    }
                }
            }, 1000);
        }

        function displayAttendance(attendance) {
            let display = document.getElementById('display');
            display.innerHTML = '';
            attendance.forEach(user => {
                let li = document.createElement('li');
                li.classList.add('text-stone-100', 'hover:text-stone-500', 'list-none', 'h-fit', 'w-fit')

                //Color depending on present
                
                let container = document.createElement('div');
                let total = user.total;
                let percent = user.present / total;
                if(percent < 0.25) {
                    container.classList.add('bg-red-500');
                } else if(percent < 0.5) {
                    container.classList.add('bg-orange-500');
                } else if(percent < 0.75) {
                    container.classList.add('bg-yellow-500');
                } else {
                    container.classList.add('bg-green-500');
                }
                container.classList.add('flex', 'flex-col', 'flex-wrap', 'h-fit', 'my-5')
                let span = document.createElement('span');
                span.classList.add('block', 'w-full', 'text-center', 'p-2', 'border', 'border-sky-400', 'border-b-0', 'h12')
                let attendanceSpan = document.createElement('span');
                attendanceSpan.classList.add('text-xl', 'text-center', 'text-white', 'w-full', 'border', 'border-sky-400', 'h-12');
                attendanceSpan.innerHTML = `${user.present}/${user.total}`;
                span.innerHTML = `${user.login}`;
                container.appendChild(span);
                container.appendChild(attendanceSpan);
                li.appendChild(container);
                // li.innerHTML = `${user.login} - ${user.present}/${user.total}`;
                display.appendChild(li);
            });
        }

        attendance.data = sortAttendance(attendance.data);

        displayAttendance(attendance.data);
        dualTimes(attendance.server_time);
        
    </script> -->
</body>
</html>